packages:
  animations: !include animations.yaml

globals:
  - id: ${widget_name}_supported_features
    type: int
    restore_value: no
    initial_value: '63'

  - id: ${widget_name}_current_mode
    type: int
    initial_value: '0'

  - id: ${widget_name}_pending_action
    type: std::string
    restore_value: no
    initial_value: ""

  - id: ${widget_name}_percentage_step
    type: float
    restore_value: no
    initial_value: '1.0'

  - id: ${widget_name}_current_percentage
    type: int
    restore_value: no
    initial_value: '0'

  - id: ${widget_name}_is_animating
    type: bool
    restore_value: no
    initial_value: 'false'


sensor:
  - platform: homeassistant
    id: ${widget_name}_supported_features_sensor
    entity_id: "${fan_entity}" 
    attribute: supported_features
    on_value:
      - lambda: |-
          ESP_LOGD("fan", "Supported features: %.0f", x);
          
          id(${widget_name}_supported_features) = x;
          
          // SET_SPEED = 1
          bool has_set_speed = (int(x) & 1) != 0;
          // OSCILLATE = 2
          bool has_oscillate = (int(x) & 2) != 0;
          // DIRECTION = 4
          bool has_direction = (int(x) & 4) != 0;
          // PRESET_MODE = 8
          bool has_preset_mode = (int(x) & 8) != 0;
          
          ESP_LOGD("fan", "Has preset_mode: %d", has_preset_mode);
          
          // Скрываем/показываем арку
          if (has_set_speed) {
            lv_obj_add_flag(id(${widget_name}_arc), LV_OBJ_FLAG_CLICKABLE);
            lv_obj_clear_flag(id(${widget_name}_arc), LV_OBJ_FLAG_HIDDEN);
          } else {
            lv_obj_clear_flag(id(${widget_name}_arc), LV_OBJ_FLAG_CLICKABLE);
            lv_obj_add_flag(id(${widget_name}_arc), LV_OBJ_FLAG_HIDDEN);
          }
          
          // Управление кнопками OSCILLATE и DIRECTION
          if (has_oscillate || has_direction) {
            // Показываем оба контейнера
            lv_obj_clear_flag(id(${widget_name}_oscillating_btn_bg), LV_OBJ_FLAG_HIDDEN);
            lv_obj_clear_flag(id(${widget_name}_direction_btn_bg), LV_OBJ_FLAG_HIDDEN);
            
            // OSCILLATE
            if (has_oscillate) {
              lv_obj_add_flag(id(${widget_name}_oscillating_btn), LV_OBJ_FLAG_CLICKABLE);
              lv_obj_set_style_text_color(id(${widget_name}_oscillating_btn_icon), lv_color_hex(0x9DB4C0), 0);
            } else {
              lv_obj_clear_flag(id(${widget_name}_oscillating_btn), LV_OBJ_FLAG_CLICKABLE);
              lv_obj_set_style_text_color(id(${widget_name}_oscillating_btn_icon), lv_color_hex(0x3D5A6C), 0);
            }
            
            // DIRECTION
            if (has_direction) {
              lv_obj_add_flag(id(${widget_name}_direction_btn), LV_OBJ_FLAG_CLICKABLE);
              lv_obj_set_style_text_color(id(${widget_name}_direction_btn_icon), lv_color_hex(0x9DB4C0), 0);
            } else {
              lv_obj_clear_flag(id(${widget_name}_direction_btn), LV_OBJ_FLAG_CLICKABLE);
              lv_obj_set_style_text_color(id(${widget_name}_direction_btn_icon), lv_color_hex(0x3D5A6C), 0);
            }
          } else {
            // Скрываем оба контейнера
            lv_obj_add_flag(id(${widget_name}_oscillating_btn_bg), LV_OBJ_FLAG_HIDDEN);
            lv_obj_add_flag(id(${widget_name}_direction_btn_bg), LV_OBJ_FLAG_HIDDEN);
          }
          
          // PRESET_MODE кнопка
          if (has_preset_mode) {
            ESP_LOGD("fan", "Showing preset button");
            lv_obj_clear_flag(id(${widget_name}_controls_presets), LV_OBJ_FLAG_HIDDEN);
          } else {
            ESP_LOGD("fan", "Hiding preset button");
            lv_obj_add_flag(id(${widget_name}_controls_presets), LV_OBJ_FLAG_HIDDEN);
          }

  - platform: homeassistant
    id: ${widget_name}_percentage_sensor
    entity_id: "${fan_entity}" 
    attribute: percentage
    on_value:
      - lambda: |-
          id(${widget_name}_current_percentage) = int(x);
          
      - lvgl.arc.update:
          id: ${widget_name}_arc
          value: !lambda return int(x);
          clickable: true
          indicator:
            arc_color: color_green

      - lvgl.label.update:
          id: ${widget_name}_percentage_label
          text: !lambda |-
            static char buf[8];
            snprintf(buf, sizeof(buf), "%.0f%%", x);
            return buf;
      
      # Обновляем скорость ТОЛЬКО если вентилятор включен!
      - if:
          condition:
            lambda: 'return id(${widget_name}_state_sensor).state == "on";'
          then:
            - script.execute: ${widget_name}_update_animation_speed

  - platform: homeassistant
    id: ${widget_name}_percentage_step_sensor
    entity_id: "${fan_entity}" 
    attribute: percentage_step
    on_value:
      - lambda: |-
          id(${widget_name}_percentage_step) = x;


text_sensor:
  - platform: homeassistant
    id: ${widget_name}_state_sensor
    entity_id: "${fan_entity}"
    on_value:
      - script.execute: ${widget_name}_translations

      - lambda: |-
          ESP_LOGD("fan", "State changed to: %s", x.c_str());
          
      - if:
          condition:
            lambda: 'return x == "on";'
          then:
            - lvgl.obj.update:
                id: ${widget_name}_state_image_bg
                bg_color: color_green
            - script.execute: ${widget_name}_start_animation
          else:
            - lvgl.obj.update:
                id: ${widget_name}_state_image_bg
                bg_color: color_misty_blue
            - script.execute: ${widget_name}_stop_animation
 

  - platform: homeassistant
    id: ${widget_name}_preset_modes_sensor
    entity_id: "${fan_entity}"
    attribute: preset_modes
    on_value:
      - script.execute: ${widget_name}_update_preset_buttons_visibility

  - platform: homeassistant
    id: ${widget_name}_preset_mode_sensor
    entity_id: "${fan_entity}"
    attribute: preset_mode
    on_value:
      - if:
          condition:
            lambda: 'return x == "none";'
          then:
            - lvgl.label.update:
                id: ${widget_name}_eco_preset_label
                text_color: color_misty_blue
            - lvgl.label.update:
                id: ${widget_name}_home_preset_label
                text_color: color_misty_blue        
            - lvgl.label.update:
                id: ${widget_name}_away_preset_label
                text_color: color_misty_blue
            - lvgl.label.update:
                id: ${widget_name}_comfort_preset_label
                text_color: color_misty_blue        
            - lvgl.label.update:
                id: ${widget_name}_boost_preset_label
                text_color: color_misty_blue
            - lvgl.label.update:
                id: ${widget_name}_sleep_preset_label
                text_color: color_misty_blue        
            - lvgl.label.update:
                id: ${widget_name}_smart_preset_label
                text_color: color_misty_blue
      - if:
          condition:
            lambda: 'return x == "eco";'
          then:
            - lvgl.label.update:
                id: ${widget_name}_eco_preset_label
                text_color: color_green
            - lvgl.label.update:
                id: ${widget_name}_home_preset_label
                text_color: color_misty_blue        
            - lvgl.label.update:
                id: ${widget_name}_away_preset_label
                text_color: color_misty_blue
            - lvgl.label.update:
                id: ${widget_name}_comfort_preset_label
                text_color: color_misty_blue        
            - lvgl.label.update:
                id: ${widget_name}_boost_preset_label
                text_color: color_misty_blue
            - lvgl.label.update:
                id: ${widget_name}_sleep_preset_label
                text_color: color_misty_blue        
            - lvgl.label.update:
                id: ${widget_name}_smart_preset_label
                text_color: color_misty_blue
      - if:
          condition:
            lambda: 'return x == "home";'
          then:
            - lvgl.label.update:
                id: ${widget_name}_eco_preset_label
                text_color: color_misty_blue
            - lvgl.label.update:
                id: ${widget_name}_home_preset_label
                text_color: color_blue        
            - lvgl.label.update:
                id: ${widget_name}_away_preset_label
                text_color: color_misty_blue
            - lvgl.label.update:
                id: ${widget_name}_comfort_preset_label
                text_color: color_misty_blue        
            - lvgl.label.update:
                id: ${widget_name}_boost_preset_label
                text_color: color_misty_blue
            - lvgl.label.update:
                id: ${widget_name}_sleep_preset_label
                text_color: color_misty_blue        
            - lvgl.label.update:
                id: ${widget_name}_smart_preset_label
                text_color: color_misty_blue
      - if:
          condition:
            lambda: 'return x == "away";'
          then:
            - lvgl.label.update:
                id: ${widget_name}_eco_preset_label
                text_color: color_misty_blue
            - lvgl.label.update:
                id: ${widget_name}_home_preset_label
                text_color: color_misty_blue    
            - lvgl.label.update:
                id: ${widget_name}_away_preset_label
                text_color: color_orange
            - lvgl.label.update:
                id: ${widget_name}_comfort_preset_label
                text_color: color_misty_blue        
            - lvgl.label.update:
                id: ${widget_name}_boost_preset_label
                text_color: color_misty_blue
            - lvgl.label.update:
                id: ${widget_name}_sleep_preset_label
                text_color: color_misty_blue        
            - lvgl.label.update:
                id: ${widget_name}_smart_preset_label
                text_color: color_misty_blue
      - if:
          condition:
            lambda: 'return x == "comfort";'
          then:
            - lvgl.label.update:
                id: ${widget_name}_eco_preset_label
                text_color: color_misty_blue
            - lvgl.label.update:
                id: ${widget_name}_home_preset_label
                text_color: color_misty_blue    
            - lvgl.label.update:
                id: ${widget_name}_away_preset_label
                text_color: color_misty_blue
            - lvgl.label.update:
                id: ${widget_name}_comfort_preset_label
                text_color: color_yellow        
            - lvgl.label.update:
                id: ${widget_name}_boost_preset_label
                text_color: color_misty_blue
            - lvgl.label.update:
                id: ${widget_name}_sleep_preset_label
                text_color: color_misty_blue        
            - lvgl.label.update:
                id: ${widget_name}_smart_preset_label
                text_color: color_misty_blue
      - if:
          condition:
            lambda: 'return x == "boost";'
          then:
            - lvgl.label.update:
                id: ${widget_name}_eco_preset_label
                text_color: color_misty_blue
            - lvgl.label.update:
                id: ${widget_name}_home_preset_label
                text_color: color_misty_blue    
            - lvgl.label.update:
                id: ${widget_name}_away_preset_label
                text_color: color_misty_blue
            - lvgl.label.update:
                id: ${widget_name}_comfort_preset_label
                text_color: color_misty_blue        
            - lvgl.label.update:
                id: ${widget_name}_boost_preset_label
                text_color: color_red
            - lvgl.label.update:
                id: ${widget_name}_sleep_preset_label
                text_color: color_misty_blue        
            - lvgl.label.update:
                id: ${widget_name}_smart_preset_label
                text_color: color_misty_blue
      - if:
          condition:
            lambda: 'return x == "sleep";'
          then:
            - lvgl.label.update:
                id: ${widget_name}_eco_preset_label
                text_color: color_misty_blue
            - lvgl.label.update:
                id: ${widget_name}_home_preset_label
                text_color: color_misty_blue    
            - lvgl.label.update:
                id: ${widget_name}_away_preset_label
                text_color: color_misty_blue
            - lvgl.label.update:
                id: ${widget_name}_comfort_preset_label
                text_color: color_misty_blue        
            - lvgl.label.update:
                id: ${widget_name}_boost_preset_label
                text_color: color_misty_blue
            - lvgl.label.update:
                id: ${widget_name}_sleep_preset_label
                text_color: color_dark_blue        
            - lvgl.label.update:
                id: ${widget_name}_smart_preset_label
                text_color: color_misty_blue
      - if:
          condition:
            lambda: 'return x == "smart";'
          then:
            - lvgl.label.update:
                id: ${widget_name}_eco_preset_label
                text_color: color_misty_blue
            - lvgl.label.update:
                id: ${widget_name}_home_preset_label
                text_color: color_misty_blue    
            - lvgl.label.update:
                id: ${widget_name}_away_preset_label
                text_color: color_misty_blue
            - lvgl.label.update:
                id: ${widget_name}_comfort_preset_label
                text_color: color_misty_blue        
            - lvgl.label.update:
                id: ${widget_name}_boost_preset_label
                text_color: color_misty_blue
            - lvgl.label.update:
                id: ${widget_name}_sleep_preset_label
                text_color: color_misty_blue        
            - lvgl.label.update:
                id: ${widget_name}_smart_preset_label
                text_color: color_crimson


  - platform: homeassistant
    id: ${widget_name}_direction_sensor
    entity_id: "${fan_entity}"
    attribute: direction
    on_value:
      - if:
          condition:
            lambda: 'return x == "forward";'
          then:
            - lvgl.label.update:
                id: ${widget_name}_direction_btn_icon
                text: "${rotate_right_icon}"
          else:
            - lvgl.label.update:
                id: ${widget_name}_direction_btn_icon
                text: "${rotate_left_icon}"
      
      # Обновляем направление ТОЛЬКО если вентилятор включен!
      - if:
          condition:
            lambda: 'return id(${widget_name}_state_sensor).state == "on";'
          then:
            - script.execute: ${widget_name}_update_animation_direction

  - platform: homeassistant
    id: ${widget_name}_name_sensor
    entity_id: "${fan_entity}"
    attribute: friendly_name
    on_value: 
      - lvgl.label.update:
          id: ${widget_name}_name_label
          text: !lambda return x;
        

binary_sensor:

  - platform: homeassistant
    id: ${widget_name}_oscillating_sensor
    entity_id: "${fan_entity}"
    attribute: oscillating
    on_state:
      if:
        condition:
          lambda: 'return x;'
        then:
          - lvgl.label.update:
              id: ${widget_name}_oscillating_btn_icon
              text: "${swing_on_icon}"
        else:
          - lvgl.label.update:
              id: ${widget_name}_oscillating_btn_icon
              text: "${swing_off_icon}"



lvgl:
  pages:
    - id: ${widget_name}_page
      bg_color: color_black
      scrollable: false
      widgets:

        - label:
            id: ${widget_name}_name_label
            y: 23
            align: top_mid
            text_font: nunito_30
            text_color: color_misty_blue
            text: "My Fan"

        - obj:
            id: ${widget_name}_main_background
            y: 90
            width: 660
            height: 270
            align: top_mid
            clickable: false
            scrollable: false
            radius: 30
            pad_all: 0
            bg_color: color_slate_blue_gray
            border_opa: transp
            border_width: 0
            shadow_opa: transp
            widgets:
              # PRESETS
              - obj:
                  id: ${widget_name}_controls_presets
                  width: 600
                  height: 60
                  align: top_mid
                  pad_all: 0
                  bg_opa: transp
                  border_opa: transp
                  border_width: 0
                  shadow_opa: transp
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: center
                    flex_align_cross: center
                    flex_align_track: center
                  widgets:

                    # ECO
                    - obj:
                        id: ${widget_name}_eco_preset_btn
                        hidden: true
                        width: 53
                        height: 53
                        pad_all: 0
                        bg_opa: transp
                        border_opa: transp
                        shadow_opa: transp
                        widgets:
                          - label:
                              id: ${widget_name}_eco_preset_label
                              align: center
                              text_font: mdi_icons_36
                              text_color: color_misty_blue
                              text: "${eco_preset_icon}"
                        on_press:
                          - homeassistant.action: 
                              action: ${widget_name}.set_preset_mode
                              data: 
                                entity_id: "${widget_name}_entity"
                                preset_mode: eco

                    # AWAY
                    - obj:
                        id: ${widget_name}_away_preset_btn
                        hidden: true
                        width: 53
                        height: 53
                        pad_all: 0
                        bg_opa: transp
                        border_opa: transp
                        shadow_opa: transp
                        widgets:
                          - label:
                              id: ${widget_name}_away_preset_label
                              align: center
                              text_font: mdi_icons_36
                              text_color: color_misty_blue
                              text: "${away_preset_icon}"
                        on_press:
                          - homeassistant.action: 
                              action: ${widget_name}.set_preset_mode
                              data: 
                                entity_id: "${widget_name}_entity"
                                preset_mode: away

                    # BOOST
                    - obj:
                        id: ${widget_name}_boost_preset_btn
                        hidden: true
                        width: 53
                        height: 53
                        pad_all: 0
                        bg_opa: transp
                        border_opa: transp
                        shadow_opa: transp
                        widgets:
                          - label:
                              id: ${widget_name}_boost_preset_label
                              align: center
                              text_font: mdi_icons_36
                              text_color: color_misty_blue
                              text: "${boost_preset_icon}"
                        on_press:
                          - homeassistant.action: 
                              action: ${widget_name}.set_preset_mode
                              data: 
                                entity_id: "${widget_name}_entity"
                                preset_mode: boost

                    # COMFORT
                    - obj:
                        id: ${widget_name}_comfort_preset_btn
                        hidden: true
                        width: 53
                        height: 53
                        pad_all: 0
                        bg_opa: transp
                        border_opa: transp
                        shadow_opa: transp
                        widgets:
                          - label:
                              id: ${widget_name}_comfort_preset_label
                              align: center
                              text_font: mdi_icons_36
                              text_color: color_misty_blue
                              text: "${comfort_preset_icon}"
                        on_press:
                          - homeassistant.action: 
                              action: ${widget_name}.set_preset_mode
                              data: 
                                entity_id: "${widget_name}_entity"
                                preset_mode: comfort

                    # HOME
                    - obj:
                        id: ${widget_name}_home_preset_btn
                        hidden: true
                        width: 53
                        height: 53
                        pad_all: 0
                        bg_opa: transp
                        border_opa: transp
                        shadow_opa: transp
                        widgets:
                          - label:
                              id: ${widget_name}_home_preset_label
                              align: center
                              text_font: mdi_icons_36
                              text_color: color_misty_blue
                              text: "${home_preset_icon}"
                        on_press:
                          - homeassistant.action: 
                              action: ${widget_name}.set_preset_mode
                              data: 
                                entity_id: "${widget_name}_entity"
                                preset_mode: home

                    # SLEEP
                    - obj:
                        id: ${widget_name}_sleep_preset_btn
                        hidden: true
                        width: 53
                        height: 53
                        pad_all: 0
                        bg_opa: transp
                        border_opa: transp
                        shadow_opa: transp
                        widgets:
                          - label:
                              id: ${widget_name}_sleep_preset_label
                              align: center
                              text_font: mdi_icons_36
                              text_color: color_misty_blue
                              text: "${sleep_preset_icon}"
                        on_press:
                          - homeassistant.action: 
                              action: ${widget_name}.set_preset_mode
                              data: 
                                entity_id: "${widget_name}_entity"
                                preset_mode: sleep

                    # BRAIN
                    - obj:
                        id: ${widget_name}_smart_preset_btn
                        hidden: true
                        width: 53
                        height: 53
                        pad_all: 0
                        bg_opa: transp
                        border_opa: transp
                        shadow_opa: transp
                        widgets:
                          - label:
                              id: ${widget_name}_smart_preset_label
                              align: center
                              text_font: mdi_icons_36
                              text_color: color_misty_blue
                              text: "${smart_preset_icon}"
                        on_press:
                          - homeassistant.action: 
                              action: ${widget_name}.set_preset_mode
                              data: 
                                entity_id: "${widget_name}_entity"
                                preset_mode: smart

              - obj:
                  id: ${widget_name}_state_widget
                  width: 660
                  height: 150
                  align: center
                  clickable: false
                  radius: 30
                  pad_all: 0
                  bg_opa: transp
                  border_opa: transp
                  border_width: 0
                  shadow_opa: transp
                  widgets:
                    # ICON
                    - obj:
                        id: ${widget_name}_state_image_bg
                        x: 30
                        width: 120
                        height: 120
                        align: left_mid
                        bg_color: color_misty_blue
                        bg_opa: 20%
                        border_opa: transp
                        shadow_opa: transp
                        radius: 90
                        widgets:
                          - image:
                              id: ${widget_name}_state_image
                              x: 0
                              y: 0
                              align: center
                              src: fan_misty_image

                    # STATE INFO
                    - obj:
                        width: 450
                        height: 180
                        align: right_mid
                        bg_color: color_steel_blue
                        bg_opa: transp
                        border_opa: transp
                        border_width: 0
                        shadow_opa: transp
                        radius: 15
                        widgets:
                          - label:
                              id: ${widget_name}_state_label
                              y: -8
                              height: 60
                              width: 390
                              long_mode: DOT
                              align: CENTER
                              text_color: color_misty_blue
                              text_font: nunito_30
                              text: "Off"
                          - label:
                              id: ${widget_name}_percentage_label
                              y: 38
                              height: 60
                              width: 390
                              align: CENTER
                              text_color: color_misty_blue
                              text_font: nunito_28
                              text: "100%"
  

        - obj:
            id: ${widget_name}_primary_buttons_background
            y: 375
            width: 660
            height: 150
            align: top_mid
            clickable: false
            scrollable: false
            radius: 30
            pad_all: 0
            bg_color: color_slate_blue_gray
            border_opa: transp
            border_width: 0
            shadow_opa: transp
            widgets:
              - obj:
                  id: ${widget_name}_primary_buttons_controls
                  width: 660
                  height: 150
                  align: center
                  clickable: false
                  scrollable: false
                  radius: 30
                  pad_all: 0
                  bg_opa: transp
                  border_opa: transp
                  border_width: 0
                  shadow_opa: transp
                  widgets:

                    # DIRECTION
                    - obj:
                        id: ${widget_name}_direction_btn_bg
                        x: 45
                        width: 135
                        height: 135
                        align: left_mid
                        pad_all: 0
                        bg_opa: transp
                        shadow_opa: transp
                        border_opa: transp
                        widgets:
                          - button:
                              id: ${widget_name}_direction_btn
                              width: 105
                              height: 105
                              align: center
                              clickable: true
                              radius: 75
                              pad_all: 0
                              bg_opa: transp
                              border_opa: transp
                              border_width: 0
                              shadow_width: 12
                              shadow_spread: 3
                              shadow_ofs_y: 0
                              shadow_color: color_black
                              shadow_opa: cover
                              pressed:
                                bg_color: color_steel_blue
                                shadow_width: 6
                              on_click:
                                if:
                                  condition:
                                    lambda: 'return id(${widget_name}_direction_sensor).state == "forward";'
                                  then:
                                    - homeassistant.action:
                                        action: fan.set_direction
                                        data:
                                          entity_id: "${fan_entity}"
                                          direction: reverse
                                  else:
                                    - homeassistant.action:
                                        action: fan.set_direction
                                        data:
                                          entity_id: "${fan_entity}"
                                          direction: forward

                          - obj:
                              width: 90
                              height: 90
                              align: center
                              clickable: false
                              radius: 68
                              pad_all: 0
                              bg_opa: transp 
                              border_opa: transp
                              shadow_width: 6
                              shadow_color: 0xFFFFFF
                              shadow_ofs_x: -6
                              shadow_ofs_y: -3
                              shadow_opa: 30%

                          - obj:
                              width: 98
                              height: 98
                              pad_all: 0
                              align: center
                              clickable: false
                              radius: 75
                              border_opa: transp
                              bg_color: color_slate_blue_gray
                              widgets:
                                - label:
                                    id: ${widget_name}_direction_btn_icon
                                    align: center
                                    text_font: mdi_icons_42
                                    text_color: color_misty_blue
                                    text: "${rotate_left_icon}"

                    # OSCILLATING BUTTON
                    - obj:
                        id: ${widget_name}_oscillating_btn_bg
                        x: -45
                        width: 135
                        height: 135
                        align: right_mid
                        pad_all: 0
                        bg_opa: transp
                        shadow_opa: transp
                        border_opa: transp
                        widgets:
                          - button:
                              id: ${widget_name}_oscillating_btn
                              width: 105
                              height: 105
                              align: center
                              clickable: true
                              radius: 75
                              pad_all: 0
                              bg_opa: transp
                              border_opa: transp
                              border_width: 0
                              shadow_width: 12
                              shadow_spread: 3
                              shadow_ofs_y: 0
                              shadow_color: color_black
                              shadow_opa: cover
                              pressed:
                                bg_color: color_steel_blue
                                shadow_width: 6
                              on_click:
                                if:
                                  condition:
                                    lambda: return id(${widget_name}_oscillating_sensor).state;
                                  then:
                                    - homeassistant.action:
                                        action: fan.oscillate
                                        data:
                                          entity_id: "${fan_entity}"
                                          oscillating: 'false'
                                  else:
                                    - homeassistant.action:
                                        action: fan.oscillate
                                        data:
                                          entity_id: "${fan_entity}"
                                          oscillating: 'true'
                          - obj:
                              width: 90
                              height: 90
                              align: center
                              clickable: false
                              radius: 68
                              pad_all: 0
                              bg_opa: transp 
                              border_opa: transp
                              shadow_width: 6
                              shadow_color: 0xFFFFFF
                              shadow_ofs_x: -6
                              shadow_ofs_y: -3
                              shadow_opa: 30%

                          - obj:
                              width: 98
                              height: 98
                              pad_all: 0
                              align: center
                              clickable: false
                              radius: 75
                              border_opa: transp
                              bg_color: color_slate_blue_gray
                              widgets:
                                - label:
                                    id: ${widget_name}_oscillating_btn_icon
                                    align: center
                                    text_font: mdi_icons_42
                                    text_color: color_misty_blue
                                    text: "${swing_off_icon}"
                                

        - obj:
            id: ${widget_name}_secondary_buttons_background
            y: 540
            width: 660
            height: 90
            align: top_mid
            clickable: false
            scrollable: false
            radius: 30
            pad_all: 0
            bg_color: color_slate_blue_gray
            border_opa: transp
            border_width: 0
            shadow_opa: transp

        # CIRCLE
        - obj:
            id: ${widget_name}_circle_background
            y: 90
            width: 225
            height: 225
            align: center
            clickable: false
            radius: 113
            pad_all: 0
            bg_color: color_black
            border_opa: transp
            border_width: 0
            shadow_opa: transp
            widgets:
              - obj:
                  width: 150
                  height: 150
                  pad_all: 0
                  align: center
                  clickable: false
                  radius: 75
                  border_opa: transp
                  bg_color: color_slate_blue_gray


              - obj:
                  width: 225
                  height: 225
                  align: center
                  clickable: false
                  radius: 113
                  pad_all: 0
                  bg_opa: transp
                  border_opa: transp
                  border_width: 0
                  shadow_opa: transp
                  widgets:
                    - arc:
                        clickable: false
                        adjustable: false
                        adv_hittest: false
                        align: center
                        width: 195
                        height: 195
                        min_value: 0
                        max_value: 100
                        start_angle: 0
                        end_angle: 360
                        rotation: 0
                        arc_width: 8
                        arc_color: color_steel_blue
                        arc_rounded: false
                        indicator:
                          arc_width: 8
                          arc_opa: transp
                        knob:
                          bg_opa: transp
                    - arc:
                        id: ${widget_name}_arc
                        clickable: true
                        adjustable: true
                        adv_hittest: true
                        align: center
                        width: 195
                        height: 195
                        min_value: 0
                        max_value: 100
                        start_angle: 0
                        end_angle: 270
                        rotation: 135
                        arc_width: 8
                        arc_color: color_steel_blue
                        arc_rounded: false
                        indicator:
                          arc_width: 8
                          arc_color: color_steel_blue
                        knob:
                          bg_opa: transp

                        on_value:
                          - lvgl.label.update:
                              id: ${widget_name}_percentage_label
                              text: !lambda |-
                                static char buffer[16];
                                snprintf(buffer, sizeof(buffer), "%d%%", int(x));
                                return buffer;

                        on_release:
                          - lambda: |-
                              int raw_value = int(x);
                              int rounded_value = raw_value;
                              
                              // Округление до ближайшего шага
                              float step = id(${widget_name}_percentage_step);
                              if (step > 1.0) {
                                // Вычисляем количество шагов
                                int num_steps = round(raw_value / step);
                                rounded_value = round(num_steps * step);
                                
                                // Ограничиваем диапазон 0-100
                                if (rounded_value < 0) rounded_value = 0;
                                if (rounded_value > 100) rounded_value = 100;
                                
                                // Обновляем визуальное отображение арки
                                lv_arc_set_value(id(${widget_name}_arc), rounded_value);
                              }
                              
                              // Сохраняем значение для последующего использования
                              id(${widget_name}_current_percentage) = rounded_value;
                          
                          - homeassistant.action:
                              action: fan.set_percentage
                              data:
                                entity_id: "${fan_entity}"
                                percentage: !lambda |-
                                  return to_string(id(${widget_name}_current_percentage));

                    - obj:
                        width: 150
                        height: 150
                        pad_all: 0
                        align: center
                        clickable: false
                        radius: 75
                        border_opa: transp
                        bg_opa: transp
                        widgets:
                          - label:
                              id: ${widget_name}_switch_icon
                              align: CENTER
                              text_color: color_misty_blue
                              text_font: mdi_icons_78
                              text: "${power_icon}"
                              on_press:
                                - if:
                                    condition:
                                      lambda: 'return id(${widget_name}_state_sensor).state == "off";'
                                    then:
                                      - homeassistant.action:
                                          action: fan.turn_on
                                          data:
                                            entity_id: "${fan_entity}"
                                    else:
                                      - homeassistant.action:
                                          action: fan.turn_off
                                          data:
                                            entity_id: "${fan_entity}"

        # BACK
        - obj:
            y: 0
            width: 120
            height: 105
            align: bottom_mid
            bg_opa: transp
            pad_all: 0
            border_opa: transp
            border_width: 0
            shadow_opa: transp
            radius: 0
            widgets:
              - obj:
                  y: -30
                  width: 120
                  height: 8
                  align: bottom_mid
                  bg_color: color_steel_blue
                  pad_all: 0
                  border_opa: transp
                  border_width: 0
                  shadow_opa: transp
                  radius: 23 
            on_click:
              - lvgl.widget.hide: fan_select_widget
              - lvgl.page.show: home_page




script:

  - id: ${widget_name}_translations
    then:
      - lvgl.label.update:
          id: ${widget_name}_state_label
          text: !lambda |-
            std::string key = "fan.state." + id(${widget_name}_state_sensor).state;
            return id(i18n_translations).translate(key);


  - id: ${widget_name}_update_preset_buttons_visibility
    then:
      - lambda: |-
          std::string presets_str = id(${widget_name}_preset_modes_sensor).state;
          ESP_LOGD("HVAC", "Available presets: %s", presets_str.c_str());
          
          // ECO
          if (presets_str.find("eco") != std::string::npos) {
            lv_obj_clear_flag(id(${widget_name}_eco_preset_btn), LV_OBJ_FLAG_HIDDEN);
          } else {
            lv_obj_add_flag(id(${widget_name}_eco_preset_btn), LV_OBJ_FLAG_HIDDEN);
          }
          
          // AWAY
          if (presets_str.find("away") != std::string::npos) {
            lv_obj_clear_flag(id(${widget_name}_away_preset_btn), LV_OBJ_FLAG_HIDDEN);
          } else {
            lv_obj_add_flag(id(${widget_name}_away_preset_btn), LV_OBJ_FLAG_HIDDEN);
          }
          
          // BOOST
          if (presets_str.find("boost") != std::string::npos) {
            lv_obj_clear_flag(id(${widget_name}_boost_preset_btn), LV_OBJ_FLAG_HIDDEN);
          } else {
            lv_obj_add_flag(id(${widget_name}_boost_preset_btn), LV_OBJ_FLAG_HIDDEN);
          }
          
          // COMFORT
          if (presets_str.find("comfort") != std::string::npos) {
            lv_obj_clear_flag(id(${widget_name}_comfort_preset_btn), LV_OBJ_FLAG_HIDDEN);
          } else {
            lv_obj_add_flag(id(${widget_name}_comfort_preset_btn), LV_OBJ_FLAG_HIDDEN);
          }
          
          // HOME
          if (presets_str.find("home") != std::string::npos) {
            lv_obj_clear_flag(id(${widget_name}_home_preset_btn), LV_OBJ_FLAG_HIDDEN);
          } else {
            lv_obj_add_flag(id(${widget_name}_home_preset_btn), LV_OBJ_FLAG_HIDDEN);
          }
          
          // SLEEP
          if (presets_str.find("sleep") != std::string::npos) {
            lv_obj_clear_flag(id(${widget_name}_sleep_preset_btn), LV_OBJ_FLAG_HIDDEN);
          } else {
            lv_obj_add_flag(id(${widget_name}_sleep_preset_btn), LV_OBJ_FLAG_HIDDEN);
          }
          
          // ACTIVITY
          if (presets_str.find("smart") != std::string::npos) {
            lv_obj_clear_flag(id(${widget_name}_smart_preset_btn), LV_OBJ_FLAG_HIDDEN);
          } else {
            lv_obj_add_flag(id(${widget_name}_smart_preset_btn), LV_OBJ_FLAG_HIDDEN);
          }
          
          ESP_LOGD("HVAC", "Preset buttons visibility updated");
